# サンプルサイズガイド

サンプルサイズとテスト期間を計算するためのリファレンス。

## サンプルサイズの基礎

### 必要な入力

1. **ベースラインコンバージョン率**: 現在の率
2. **最小検出効果 (MDE)**: 検出したい最小の変化
3. **統計的有意水準**: 通常は 95% (α = 0.05)
4. **統計的検出力**: 通常は 80% (β = 0.20)

### これらの意味

**ベースラインコンバージョン率**: ページの CVR が 5% なら、それがベースラインです。

**MDE（最小検出効果）**: 検出したい最小の改善幅。以下に基づいて設定します:
- ビジネスへの影響 (5% のリフトは意味があるか？)
- 実装コスト (労力に見合うか？)
- 現実的な期待値 (過去テストではどうだったか？)

**統計的有意性 (95%)**: 観測された差が偶然である確率が 5% 未満であることを意味します。

**統計的検出力 (80%)**: MDE サイズの実際の効果がある場合、それを検出できる確率が 80% であることを意味します。

---

## サンプルサイズ クイックリファレンステーブル

### コンバージョン率: 1%

| 検出したいリフト | バリアントごとのサンプル | 総サンプル |
|----------------|-------------------|--------------|
| 5% (1% → 1.05%) | 1,500,000 | 3,000,000 |
| 10% (1% → 1.1%) | 380,000 | 760,000 |
| 20% (1% → 1.2%) | 97,000 | 194,000 |
| 50% (1% → 1.5%) | 16,000 | 32,000 |
| 100% (1% → 2%) | 4,200 | 8,400 |

### コンバージョン率: 3%

| 検出したいリフト | バリアントごとのサンプル | 総サンプル |
|----------------|-------------------|--------------|
| 5% (3% → 3.15%) | 480,000 | 960,000 |
| 10% (3% → 3.3%) | 120,000 | 240,000 |
| 20% (3% → 3.6%) | 31,000 | 62,000 |
| 50% (3% → 4.5%) | 5,200 | 10,400 |
| 100% (3% → 6%) | 1,400 | 2,800 |

### コンバージョン率: 5%

| 検出したいリフト | バリアントごとのサンプル | 総サンプル |
|----------------|-------------------|--------------|
| 5% (5% → 5.25%) | 280,000 | 560,000 |
| 10% (5% → 5.5%) | 72,000 | 144,000 |
| 20% (5% → 6%) | 18,000 | 36,000 |
| 50% (5% → 7.5%) | 3,100 | 6,200 |
| 100% (5% → 10%) | 810 | 1,620 |

### コンバージョン率: 10%

| 検出したいリフト | バリアントごとのサンプル | 総サンプル |
|----------------|-------------------|--------------|
| 5% (10% → 10.5%) | 130,000 | 260,000 |
| 10% (10% → 11%) | 34,000 | 68,000 |
| 20% (10% → 12%) | 8,700 | 17,400 |
| 50% (10% → 15%) | 1,500 | 3,000 |
| 100% (10% → 20%) | 400 | 800 |

### コンバージョン率: 20%

| 検出したいリフト | バリアントごとのサンプル | 総サンプル |
|----------------|-------------------|--------------|
| 5% (20% → 21%) | 60,000 | 120,000 |
| 10% (20% → 22%) | 16,000 | 32,000 |
| 20% (20% → 24%) | 4,000 | 8,000 |
| 50% (20% → 30%) | 700 | 1,400 |
| 100% (20% → 40%) | 200 | 400 |

---

## 期間計算

### 計算式

```
期間（日） = （バリアントごとのサンプル × バリアント数） / （日次トラフィック × 露出率）
```

### 例

**シナリオ 1: 高トラフィックページ**
- 必要数: バリアントごとに 10,000（2 バリアント = 合計 20,000）
- 日次トラフィック: 5,000 訪問者
- テスト露出: 100%
- 期間: 20,000 / 5,000 = **4 日**

**シナリオ 2: 中トラフィックページ**
- 必要数: バリアントごとに 30,000（合計 60,000）
- 日次トラフィック: 2,000 訪問者
- テスト露出: 100%
- 期間: 60,000 / 2,000 = **30 日**

**シナリオ 3: 低トラフィックかつ部分露出**
- 必要数: バリアントごとに 15,000（合計 30,000）
- 日次トラフィック: 500 訪問者
- テスト露出: 50%
- 実効日次: 250
- 期間: 30,000 / 250 = **120 日**（長すぎる！）

### 最短期間のルール

サンプルサイズが十分でも、最低でも以下の期間は実施する:
- **丸 1 週間**: 曜日変動を取り込むため
- **2 つの業務サイクル**: B2B の場合（平日/週末パターン）
- **給料日をまたぐ**: EC の場合（月初/月末）

### 最長期間のガイドライン

4〜8 週間を超えてテストを続けるのは避ける:
- 新奇性効果が薄れる
- 外部要因の影響を受ける
- 他テストを行う機会コストが発生する

---

## オンライン計算ツール

### 推奨ツール

**Evan Miller の計算ツール**
https://www.evanmiller.org/ab-testing/sample-size.html
- シンプルなインターフェース
- ブックマーク推奨

**Optimizely の計算ツール**
https://www.optimizely.com/sample-size-calculator/
- ビジネス向けの分かりやすい文言
- 期間見積もりあり

**AB Test Guide の計算ツール**
https://www.abtestguide.com/calc/
- ベイズオプションを含む
- 複数のテストタイプに対応

**VWO の期間計算ツール**
https://vwo.com/tools/ab-test-duration-calculator/
- 期間計算に特化
- 計画立案に有用

---

## 複数バリアント時の調整

2 バリアントより多い場合（A/B/n テスト）は、より多くのサンプルが必要:

| バリアント数 | 係数 |
|----------|------------|
| 2 (A/B) | 1x |
| 3 (A/B/C) | ~1.5x |
| 4 (A/B/C/D) | ~2x |
| 5+ | バリアント削減を検討 |

**なぜ？** 比較数が増えると偽陽性の確率が上がるため。比較対象は:
- A vs B
- A vs C
- B vs C（場合による）

Bonferroni 補正を適用するか、自動で処理するツールを使ってください。

---

## よくあるサンプルサイズのミス

### 1. 検出力不足のテスト
**問題**: 現実的な効果を検出するのにサンプルが足りない
**対策**: MDE を現実的に設定し、トラフィックを増やす。無理ならテストしない

### 2. 過剰検出力のテスト
**問題**: すでに有意でもサンプルサイズ到達まで待ってしまう
**対策**: 実は問題なし。事前に決めたサンプルサイズを守る

### 3. 間違ったベースライン率
**問題**: 計算に誤った CVR を使う
**対策**: サイト全体平均ではなく、対象ページ・対象指標の率を使う

### 4. セグメントを無視する
**問題**: 全体トラフィックで計算し、後でセグメント分析する
**対策**: セグメント分析を予定しているなら、最小セグメントでサンプル計算する

### 5. 同時にテストしすぎる
**問題**: トラフィックを細かく分割しすぎる
**対策**: 優先順位を厳密につけ、同時実行テストを減らす

---

## 必要サンプルが大きすぎるとき

十分なトラフィックを確保できない場合の選択肢:

1. **MDE を上げる**: 大きな効果（20%+ リフト）のみ検出対象にする
2. **信頼水準を下げる**: 95% の代わりに 90% を使う（リスクあり、要記録）
3. **バリアントを減らす**: 最有力の 1 バリアントだけテストする
4. **トラフィックを統合する**: 複数の類似ページをまとめてテストする
5. **上流でテストする**: トラフィックが多いファネル上流でテストする
6. **テストしない**: 定性データに基づいて意思決定する
7. **期間を延ばす**: 長期実施（数週間〜数か月）を受け入れる

---

## 逐次テスト

サンプルサイズ到達前に結果確認が必要な場合:

### 何か？
データを複数回確認することを考慮して補正する統計手法。

### 使う場面
- リスクの高い変更
- 悪いバリアントを早期停止したい
- 時間制約のある意思決定

### 対応ツール
- Optimizely (Stats Accelerator)
- VWO (SmartStats)
- PostHog（ベイズアプローチ）

### トレードオフ
- 早期停止の柔軟性が高い
- 必要サンプルサイズがやや増える
- 分析がより複雑になる

---

## クイック判断フレームワーク

### このテストは実施可能か？

```
対象ページの日次トラフィック: _____
ベースラインコンバージョン率: _____
重視する MDE: _____

バリアントごとの必要サンプル: _____ （上記テーブル参照）
実施日数: サンプル数 / 日次トラフィック = _____

日数 > 60 の場合: 代替案を検討
日数 > 30 の場合: 高インパクト施策なら許容
日数 < 14 の場合: 実施可能性が高い
日数 < 7 の場合: 実施は容易。ただし長めに回すことも検討
```
